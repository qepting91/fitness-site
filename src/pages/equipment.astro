---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const equipment = await getCollection('equipment');

// Group by category
const categories = {
  'cardio': { label: 'Cardio', color: 'rose', icon: 'â¤ï¸' },
  'strength-pin-loaded': { label: 'Pin-Loaded Machines', color: 'sky', icon: 'ðŸ”§' },
  'strength-plate-loaded': { label: 'Plate-Loaded Machines', color: 'violet', icon: 'ðŸ‹ï¸' },
  'strength-free-weights': { label: 'Free Weights', color: 'amber', icon: 'ðŸ’ª' },
  'functional-accessory': { label: 'Functional & Accessories', color: 'emerald', icon: 'âš¡' },
};

const groupedEquipment = equipment.reduce((acc, item) => {
  const cat = item.data.category;
  if (!acc[cat]) acc[cat] = [];
  acc[cat].push(item);
  return acc;
}, {} as Record<string, typeof equipment>);

// Count totals
const totalItems = equipment.length;
const totalPieces = equipment.reduce((sum, item) => sum + (item.data.quantity || 1), 0);
---

<BaseLayout title="My Equipment">
  <header class="mb-6">
    <h1 class="text-xl font-bold text-slate-100 mb-2">My Gym Equipment</h1>
    <p class="text-sm text-slate-400 mb-4">
      {totalItems} equipment types ({totalPieces} total pieces)
    </p>

    <!-- Category Filter Pills -->
    <div class="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4">
      <button class="filter-btn active" data-filter="all">All</button>
      {Object.entries(categories).map(([key, { label }]) => (
        <button class="filter-btn" data-filter={key}>{label}</button>
      ))}
    </div>
  </header>

  <!-- Equipment by Category -->
  <div id="equipment-list" class="space-y-6">
    {Object.entries(categories).map(([categoryKey, { label, color, icon }]) => {
      const items = groupedEquipment[categoryKey] || [];
      if (items.length === 0) return null;

      const colorClasses = {
        rose: 'bg-rose-500/20 text-rose-400 border-rose-500/30',
        sky: 'bg-sky-500/20 text-sky-400 border-sky-500/30',
        violet: 'bg-violet-500/20 text-violet-400 border-violet-500/30',
        amber: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
        emerald: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
      };

      return (
        <section class="equipment-category" data-category={categoryKey}>
          <div class="flex items-center gap-2 mb-3">
            <span class={`badge ${colorClasses[color as keyof typeof colorClasses]}`}>
              {icon} {label}
            </span>
            <span class="text-xs text-slate-500">({items.length})</span>
          </div>

          <div class="space-y-2">
            {items.map(item => (
              <div class="equipment-card card p-4" data-equipment-id={item.id}>
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-slate-100 truncate">{item.data.name}</h3>
                    <div class="flex flex-wrap items-center gap-2 mt-1">
                      {item.data.brand && (
                        <span class="text-xs text-slate-500">{item.data.brand}</span>
                      )}
                      {item.data.quantity && item.data.quantity > 1 && (
                        <span class="badge bg-slate-700/50 text-slate-300 border-slate-600/50">
                          Ã—{item.data.quantity}
                        </span>
                      )}
                    </div>
                    {item.data.notes && (
                      <p class="text-xs text-slate-500 mt-1">{item.data.notes}</p>
                    )}
                  </div>

                  <!-- Availability Toggle -->
                  <button
                    class="availability-toggle flex-shrink-0 w-12 h-7 rounded-full transition-colors relative"
                    data-available={item.data.available ? 'true' : 'false'}
                    aria-label="Toggle availability"
                  >
                    <span class="toggle-knob absolute top-0.5 w-6 h-6 rounded-full bg-white shadow transition-all"></span>
                  </button>
                </div>

                {item.data.exerciseEquipmentTags && item.data.exerciseEquipmentTags.length > 0 && (
                  <div class="flex flex-wrap gap-1 mt-3 pt-3 border-t border-slate-700/50">
                    {item.data.exerciseEquipmentTags.slice(0, 4).map(tag => (
                      <span class="text-xs px-2 py-0.5 rounded-full bg-slate-800/50 text-slate-500">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>
      );
    })}
  </div>

  <!-- Summary Stats -->
  <div class="mt-8 p-4 card">
    <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wide mb-3">Equipment Summary</h2>
    <div class="grid grid-cols-2 gap-4">
      {Object.entries(categories).map(([key, { label, color }]) => {
        const items = groupedEquipment[key] || [];
        const count = items.reduce((sum, item) => sum + (item.data.quantity || 1), 0);
        const colorClasses = {
          rose: 'text-rose-400',
          sky: 'text-sky-400',
          violet: 'text-violet-400',
          amber: 'text-amber-400',
          emerald: 'text-emerald-400',
        };
        return (
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-400">{label}</span>
            <span class={`font-semibold ${colorClasses[color as keyof typeof colorClasses]}`}>{count}</span>
          </div>
        );
      })}
    </div>
  </div>
</BaseLayout>

<style>
  .filter-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border-radius: 9999px;
    white-space: nowrap;
    transition: all 0.2s;
    background-color: rgba(30, 41, 59, 0.6);
    color: #94a3b8;
    border: 1px solid rgba(51, 65, 85, 0.5);
  }
  .filter-btn:hover {
    background-color: rgba(51, 65, 85, 0.6);
    color: #cbd5e1;
  }
  .filter-btn.active {
    background-color: rgba(139, 92, 246, 0.2);
    color: #a78bfa;
    border-color: rgba(139, 92, 246, 0.5);
  }

  .availability-toggle[data-available="true"] {
    background-color: rgba(34, 197, 94, 0.3);
  }
  .availability-toggle[data-available="false"] {
    background-color: rgba(100, 116, 139, 0.3);
  }
  .availability-toggle[data-available="true"] .toggle-knob {
    left: calc(100% - 1.625rem);
    background-color: #22c55e;
  }
  .availability-toggle[data-available="false"] .toggle-knob {
    left: 0.125rem;
    background-color: #64748b;
  }

  .equipment-category.hidden {
    display: none;
  }
</style>

<script>
  // Filter functionality
  const filterButtons = document.querySelectorAll('.filter-btn');
  const categories = document.querySelectorAll('.equipment-category');

  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const filter = btn.getAttribute('data-filter');

      categories.forEach(cat => {
        if (filter === 'all' || cat.getAttribute('data-category') === filter) {
          cat.classList.remove('hidden');
        } else {
          cat.classList.add('hidden');
        }
      });
    });
  });

  // Availability toggle (stores in localStorage)
  const toggles = document.querySelectorAll('.availability-toggle');

  // Load saved availability from localStorage
  const savedAvailability = JSON.parse(localStorage.getItem('equipment-availability') || '{}');

  toggles.forEach(toggle => {
    const card = toggle.closest('.equipment-card');
    const equipmentId = card?.getAttribute('data-equipment-id');

    if (equipmentId && savedAvailability[equipmentId] !== undefined) {
      toggle.setAttribute('data-available', savedAvailability[equipmentId] ? 'true' : 'false');
    }

    toggle.addEventListener('click', () => {
      const current = toggle.getAttribute('data-available') === 'true';
      const newValue = !current;
      toggle.setAttribute('data-available', newValue ? 'true' : 'false');

      if (equipmentId) {
        savedAvailability[equipmentId] = newValue;
        localStorage.setItem('equipment-availability', JSON.stringify(savedAvailability));
      }
    });
  });
</script>
